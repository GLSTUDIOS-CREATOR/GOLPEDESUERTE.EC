<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Spinners Overlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Fondo */
      --bgA:#0a1223; --bgB:#0c1832; --bgC:#0a0f1f;

      /* Panel */
      --panelTop:#f7faff; --panelMid:#e9f0fd; --panelBot:#d7e1f5;

      /* Título */
      --titleGlow: 0 22px 70px rgba(46,95,180,.55);

      /* Azules */
      --blueHi:#dfeaff;     /* claro para el degradado base */
      --blueMd:#8fb1ff;     /* medio */
      --blueLo:#3665d6;     /* oscuro */
      --blueDeepHi:#cfe0ff; /* claro en estado aterrizado */
      --blueDeepMd:#5e86ff; /* medio en estado aterrizado */
      --blueDeepLo:#1f3993; /* muy oscuro en estado aterrizado */
      --blueGlow:#6fa0ff;

      /* Dorado solo para “chips usados” abajo */
      --goldHi:#fff1bf; --goldMd:#ffd466; --goldLo:#d88b10;

      /* Sombras */
      --deckShadow: 0 28px 80px rgba(0,0,0,.55);
      --digitShadow: 0 24px 46px rgba(0,0,0,.38);
    }

    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(120% 140% at 50% -20%, #192a4f 0%, var(--bgA) 35%, var(--bgB) 70%, var(--bgC) 100%),
        linear-gradient(180deg, #0b1428, #0a0f1f);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:#18305a;
    }

    .wrap{ width:min(1280px,96vw); }

    /* ======== Título 3D ======== */
    .title{
      width:fit-content; margin:0 auto 16px; padding:18px 28px 16px;
      border-radius:16px; backdrop-filter: blur(2px);
      background: radial-gradient(120% 100% at 50% 0%,
                  rgba(255,255,255,.14) 0%,
                  rgba(255,255,255,.08) 55%,
                  rgba(255,255,255,.03) 100%);
      border:1px solid rgba(255,255,255,.22);
      box-shadow:
        inset 0 2px 0 rgba(255,255,255,.55),
        0 1px 0 rgba(255,255,255,.35),
        0 16px 26px rgba(0,0,0,.35),
        var(--titleGlow);
      letter-spacing:.46em;
      text-align:center;
    }
    .title span{
      display:inline-block;
      font-weight:1000;
      font-size: clamp(28px,3.8vw,54px);
      background: linear-gradient(180deg,#f9fbff 0%, #dbe7ff 65%, #b8ccff 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:
        0 1px 0 #fff,
        0 2px 0 #eef4ff,
        0 3px 0 #dfeaff,
        0 4px 0 #cbd9ff,
        0 6px 10px rgba(0,0,0,.35);
    }

    /* ======== Bandeja ======== */
    .deck{
      margin-top:10px;
      padding:26px clamp(16px,2.4vw,36px);
      border-radius:20px;
      background: linear-gradient(180deg, var(--panelTop) 0%, var(--panelMid) 54%, var(--panelBot) 100%);
      border-top:1px solid #fff; border-bottom:1px solid #b9c6e2;
      box-shadow: var(--deckShadow);
      display:flex; gap: clamp(14px,2.2vw,28px); justify-content:center; align-items:flex-end;
    }

    /* ======== Cartucho / Dígito (blanco) ======== */
    .digit{
      width: clamp(92px, 10.6vw, 142px);
      height: clamp(124px, 13.2vw, 174px);
      border-radius:24px;
      position:relative; overflow:hidden;
      background: linear-gradient(180deg,#ffffff 0%, #f3f7ff 60%, #e7eef9 100%);
      border:2px solid #f8fbff;
      box-shadow:
        inset 0 0 0 2px #ffffff,
        inset 0 -14px 0 rgba(0,0,0,.06),
        0 2px 0 #fff,
        var(--digitShadow);
    }
    .digit::before{
      content:''; position:absolute; inset:0; border-radius:24px;
      box-shadow: inset 0 3px 0 rgba(255,255,255,.95), inset 0 -12px 0 rgba(0,0,0,.08);
      pointer-events:none;
    }
    .digit::after{
      content:''; position:absolute; inset:4px; border-radius:20px;
      box-shadow: inset 0 0 0 2px rgba(90,120,220,.16);
      pointer-events:none;
      transition: box-shadow .25s ease, outline-color .25s ease;
    }

    /* Reel (0..9) */
    .reel{
      position:absolute; left:0; right:0; top:0;
      display:flex; flex-direction:column; align-items:center;
      transform: translateY(0);
      transition: transform 1.25s cubic-bezier(.17,.9,.16,1);
      will-change: transform;
    }
    .slot{
      height: clamp(124px, 13.2vw, 174px);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      font-size: clamp(62px, 8.6vw, 118px);
      /* Números (azul durante giro) */
      background: linear-gradient(180deg, var(--blueHi), var(--blueMd) 58%, var(--blueLo));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      color:transparent;
      text-shadow:
        0 1px 0 rgba(255,255,255,.95),
        0 12px 18px rgba(0,0,0,.16);
    }

    /* Al aterrizar: AZUL OSCURO alto relieve + halo */
    .digit.landed::after{
      box-shadow:
        inset 0 0 0 2px #1b033ae6,
        0 0 0 2px rgba(96,132,255,.35),
        0 0 38px rgba(94,134,255,.28);
    }
    .digit.landed .slot{
      background: linear-gradient(180deg, var(--blueDeepHi) 0%, var(--blueDeepMd) 55%, var(--blueDeepLo) 100%);
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
      color:transparent;
      text-shadow:
        0 1px 0 rgba(255,255,255,.95),
        0 0 26px color-mix(in srgb, var(--blueGlow) 80%, transparent),
        0 18px 26px rgba(0,0,0,.28),
        0 0 1px rgba(10,20,60,.45);
      animation: flash 1s ease-in-out 1, pulse 2.2s ease-in-out 3 1s;
    }
    @keyframes flash{ 0%{filter:brightness(1)} 30%{filter:brightness(1.45)} 60%{filter:brightness(1.05)} 100%{filter:brightness(1.18)} }
    @keyframes pulse{
      0%,100%{
        text-shadow:
          0 1px 0 rgba(255,255,255,.95),
          0 0 16px color-mix(in srgb, var(--blueGlow) 48%, transparent),
          0 18px 26px rgba(0,0,0,.28),
          0 0 1px rgba(10,20,60,.40);
      }
      50%{
        text-shadow:
          0 1px 0 rgb(255, 255, 255),
          0 0 36px color-mix(in srgb, var(--blueGlow) 90%, transparent),
          0 18px 26px rgba(0,0,0,.28),
          0 0 1px rgba(10,20,60,.46);
      }
    }

    /* ======== Barra 1..20 ======== */
    .bar{ display:grid; grid-template-columns: repeat(20,1fr); gap:8px; margin-top:14px }
    .chip{
      height:30px; border-radius:999px; font-weight:900; font-size:13px;
      display:flex; align-items:center; justify-content:center;
      color:#24406f;
      background: linear-gradient(180deg,#eef3ff,#dce6f8);
      border:1px solid #c7d2ea;
      box-shadow: inset 0 0 0 1px #ffffffc0, 0 12px 20px rgba(0,0,0,.18);
      opacity:.96;
    }
    .chip.used{
      color:#402e00;
      background: linear-gradient(180deg,var(--goldHi),var(--goldMd));
      border-color:#f0c24c;
      box-shadow: inset 0 0 0 1px #ffffffc0, 0 12px 20px rgba(0,0,0,.18);
    }
    .chip.active{ outline:2px solid #3f64c4; outline-offset:2px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title"><span>SPINNERS</span></div>

    <div class="deck" id="deck">
      <div class="digit"><div class="reel"></div></div>
      <div class="digit"><div class="reel"></div></div>
      <div class="digit"><div class="reel"></div></div>
      <div class="digit"><div class="reel"></div></div>
    </div>

    <div class="bar" id="bar"></div>
  </div>

  <script>
    /* ===== Util ===== */
    const DIGS = 4;
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const sleep = ms => new Promise(r=>setTimeout(r, ms));
    const bust  = () => `&_=${Date.now()}`;
    const Q = new URL(location.href).searchParams;

    let INDEX = Math.max(0, Math.min(19, parseInt(Q.get('i')||'0',10) || 0));
    let LIST  = new Array(20).fill('');

    /* ===== Datos ===== */
    async function fetchSpinners(){
      try{
        const r=await fetch('/juego/spinners?fmt=json'+bust());
        const j=await r.json();
        if(Array.isArray(j.spinners)) return j.spinners.slice(0,20);
      }catch(_){}
      try{
        const r2=await fetch('/static/db/spinners.xml'+(location.search?location.search+'&':'?')+bust());
        if(r2.ok){
          const xml=new DOMParser().parseFromString(await r2.text(),'text/xml');
          const out=[]; xml.querySelectorAll('n').forEach(n=>{
            const v=(n.getAttribute('v')||n.textContent||'').replace(/\D/g,'').slice(0,4);
            out.push(v? v.padStart(4,'0'):'');
          });
          return (out.concat(Array(20).fill(''))).slice(0,20);
        }
      }catch(_){}
      return new Array(20).fill('');
    }

    /* ===== Barra ===== */
    const bar = $('#bar');
    function buildBar(){
      bar.innerHTML='';
      for(let i=0;i<20;i++){
        const c=document.createElement('div');
        c.className='chip'; c.textContent=String(i+1).padStart(2,'0');
        if(i===INDEX) c.classList.add('active');
        bar.appendChild(c);
      }
    }
    function markUsed(i,on=true){
      const chip=bar.children[i]; if(!chip) return;
      chip.classList.toggle('used', on);
    }
    function markActive(i){
      [...bar.children].forEach((c,idx)=> c.classList.toggle('active', idx===i));
    }

    /* ===== Reels (tambola) ===== */
    function buildReels(){
      $$('#deck .reel').forEach(reel=>{
        reel.innerHTML='';
        for(let k=0;k<60;k++){ // 0..9 repetido 6 veces
          const s=document.createElement('div');
          s.className='slot';
          s.textContent=String(k%10);
          reel.appendChild(s);
        }
      });
    }
    function digitH(){
      const slot=$('.slot'); return slot? slot.getBoundingClientRect().height : 150;
    }
    async function spinDigitTo(digitEl, target, turns=3, duration=1100){
      digitEl.classList.remove('landed');
      const reel=digitEl.querySelector('.reel');
      const h=digitH();
      const steps = Math.round(turns*10 + (target%10));
      reel.style.transitionDuration=`${duration}ms`;
      reel.style.transform=`translateY(${-h*steps}px)`;
      await new Promise(res=>{
        const done=()=>{ reel.removeEventListener('transitionend',done); res(); };
        reel.addEventListener('transitionend',done,{once:true});
      });
      // normaliza
      const norm = (target%10);
      reel.style.transitionDuration='0ms';
      reel.style.transform = `translateY(${-h*norm}px)`;
      await sleep(16);
      digitEl.classList.add('landed');
    }
    async function rollTo(str, baseTurns=3){
      const s = (str||'').padStart(4,'0').slice(-4);
      const digits = $$('#deck .digit');
      for(let i=0;i<4;i++){
        await spinDigitTo(digits[i], parseInt(s[i],10), baseTurns+(i*0.5), 900+(i*140));
      }
    }
    function targetForIndex(i){
      const v=(LIST[i]||'').trim();
      return v ? v.padStart(4,'0') : '';
    }

    /* ===== Acciones ===== */
    async function doGenerate(i){
      INDEX=i; markActive(i);
      await rollTo('0000', 2);      // genera (0000) con giro corto
    }
    async function doLaunch(i){
      INDEX=i; markActive(i);
      const t=targetForIndex(i);
      if(!t) return;
      await rollTo(t, 4);           // gira más y aterriza (azul oscuro)
      markUsed(i, true);
    }

    /* ===== Mensajería ===== */
    function handleMessage(d){
      if(!d || d.type!=='solo-spin') return;
      const idx = Number.isFinite(d.index)? Math.max(0,Math.min(19,d.index)) : INDEX;
      if(d.op==='gen') doGenerate(idx);
      else if(d.op==='launch') doLaunch(idx);
    }
    try{
      const bc=new BroadcastChannel('glbingo-spin');
      bc.addEventListener('message', ev=>handleMessage(ev.data));
    }catch(_){}
    window.addEventListener('message', ev=>{
      if(ev.origin!==location.origin) return; handleMessage(ev.data);
    });
    window.addEventListener('storage', ev=>{
      if(ev.key!=='glbingo-spin-evt') return;
      try{ const d=JSON.parse(ev.newValue||'{}'); handleMessage({type:'solo-spin',op:d.op,index:d.index}); }catch(_){}
    });

    /* ===== Boot ===== */
    (async function boot(){
      buildReels();
      buildBar();
      LIST = await fetchSpinners();
      await rollTo('0000',1);  // estado inicial
    })();
  </script>
</body>
</html>
