<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Spinner Overlay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --ink:#e8eef8;
      --redTop:#ffdddd;
      --redMid:#ff3c3c;
      --redDeep:#b50000;
      --redShadow:rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:transparent; color:var(--ink);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      overflow:hidden;
    }

    /* ===== Fondo sutil translúcido ===== */
    .fx-bg{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background:
        radial-gradient(120% 80% at 50% -10%, rgba(255,80,80,.25) 0%, rgba(255,80,80,0) 46%),
        radial-gradient(100% 90% at 50% 120%, rgba(0,0,0,.4) 0%, rgba(0,0,0,0) 44%);
    }

    /* ===== Contenedor principal ===== */
    .stack{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1;
      flex-direction:column; gap:clamp(3px, 0.6vw, 8px);
    }

    /* ===== Título SPINNERS en rojo 3D ===== */
    .title3d{
      display:inline-block;
      padding: clamp(6px, .9vw, 12px) clamp(18px, 2.5vw, 32px);
      border-radius:16px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:900;
      font-size: clamp(24px, 4.6vw, 52px);
      line-height:1;
      background: linear-gradient(180deg, rgba(255,255,255,.4), rgba(255,255,255,.1));
      border:1px solid rgba(255,255,255,.25);
      box-shadow:
        0 14px 34px rgba(0,0,0,.4),
        inset 0 1px 0 rgba(255,255,255,.6),
        inset 0 -1px 0 rgba(0,0,0,.15);
      color: #ff4545;
      background-clip:text;
      -webkit-background-clip:text;
      -webkit-text-fill-color: #ff3c3c;
      text-shadow:
        0 -2px 0 var(--redTop),
        0 1px 0 var(--redMid),
        0 2px 0 var(--redMid),
        0 3px 0 var(--redDeep),
        0 4px 3px rgba(0,0,0,.45),
        0 14px 24px rgba(0,0,0,.35);
      user-select:none;
    }

    /* ===== Dígitos ===== */
    .digits{display:flex; gap:3vw; align-items:center; justify-content:center}
    .d{
      width:min(18vw,200px); height:min(24vw,260px);
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(#ffffff,#e9eef6);
      color:#0d1a32; border:1px solid #0002; border-radius:22px;
      font-weight:900; font-size:min(16vw,180px); line-height:1;
      box-shadow:
        inset 0 0 0 2px #0001,
        0 16px 28px rgba(0,0,0,.28),
        0 24px 48px rgba(0,0,0,.22);
      font-variant-numeric: tabular-nums;
      user-select:none;
      text-shadow:
        0 3px 0 rgba(255,255,255,.75),
        0 10px 26px rgba(0,0,0,.3);
    }

    .meta{position:fixed; left:10px; bottom:10px; font:12px/1.4 ui-sans-serif; opacity:.6; z-index:2}
  </style>
</head>
<body>
  <!-- Fondo -->
  <div class="fx-bg" aria-hidden="true"></div>

  <!-- Centro -->
  <div class="stack">
    <div class="title3d">SPINNERS</div>
    <div id="digits" class="digits">
      <span class="d">0</span><span class="d">0</span><span class="d">0</span><span class="d">0</span>
    </div>
  </div>

  <div class="meta">Overlay 1 • Escucha “glbingo-spin” (BroadcastChannel) y localStorage</div>

  <script>
    /* ========= LÓGICA ORIGINAL (SIN CAMBIOS) ========= */
    const $ = s => document.querySelector(s);
    const $$ = (s,root=document)=> Array.from(root.querySelectorAll(s));
    const sleep = ms => new Promise(r=>setTimeout(r, ms));
    const bust  = () => `?_=${Date.now()}`;
    const Q = new URL(location.href).searchParams;

    const DIGS = 4;
    const CHANNEL = 'glbingo-spin';

    function normalize4(v){
      if (v==null) return '';
      if (typeof v === 'object' && v.value!=null) return String(v.value).padStart(4,'0').slice(0,4);
      return String(v).replace(/\D/g,'').padStart(4,'0').slice(0,4);
    }

    async function safeJSON(url, opts={}){
      try{
        const r = await fetch(url, opts);
        if(!r.ok) throw new Error(r.statusText);
        return await r.json();
      }catch(e){ console.error('fetch', url, e); return null; }
    }

    async function fetchSpinners(){
      const j = await safeJSON('/juego/spinners'+bust());
      if (j){
        if (Array.isArray(j)) return j.slice(0,20).map(normalize4);
        if (Array.isArray(j.spinners)) return j.spinners.slice(0,20).map(normalize4);
      }
      try{
        const r1 = await fetch('/static/db/vmix_spinners.xml'+bust());
        if (r1.ok){
          const xml = new DOMParser().parseFromString(await r1.text(), "text/xml");
          const out=[];
          xml.querySelectorAll('spinner').forEach(n=> out.push(normalize4(n.getAttribute('value')||n.textContent||'')));
          if (!out.length){
            xml.querySelectorAll('n').forEach(n=> out.push(normalize4(n.getAttribute('v')||n.textContent||'')));
          }
          if (out.some(Boolean)) return out.slice(0,20);
        }
      }catch(_){}
      return new Array(20).fill('');
    }

    const digits = $('#digits');
    function setDigits(str='0000'){
      const s = (str||'').padStart(DIGS,'0').slice(-DIGS);
      const boxes = $$('.d', digits);
      for(let i=0;i<DIGS;i++) boxes[i].textContent = s[i];
    }

    async function rollDigitTo(el, targetDigit, extraTurns=1){
      let cur = /^\d$/.test(el.textContent) ? parseInt(el.textContent,10) : 0;
      const to = parseInt(targetDigit,10);
      const steps = extraTurns*10 + ((to - cur + 10) % 10);
      for(let s=0; s<steps; s++){
        cur = (cur+1) % 10;
        el.textContent = String(cur);
        const t = 30 + Math.min(220, s*3);
        await sleep(t);
      }
    }
    async function tambolaRollTo(target){
      const t = (target||'').padStart(DIGS,'0').slice(-DIGS);
      const boxes = $$('.d', digits);
      for(let i=0;i<DIGS;i++){ await rollDigitTo(boxes[i], t[i], 2+i); }
      setDigits(t);
    }

    let CUR_INDEX = -1;
    function onGen(i){ CUR_INDEX=i; setDigits('0000'); }
    async function onLaunch(i){
      CUR_INDEX=i;
      const list = await fetchSpinners();
      const target = normalize4(list[i]||'');
      if (!target){ console.warn('Spinner sin target en índice', i); return; }
      await tambolaRollTo(target);
    }

    try{
      const bc = new BroadcastChannel(CHANNEL);
      bc.addEventListener('message', async ev=>{
        const d = ev.data || {};
        if (d.type !== 'solo-spin') return;
        if (Number.isFinite(d.index)) CUR_INDEX = d.index;
        if (d.op === 'gen') onGen(CUR_INDEX);
        else if (d.op === 'launch') onLaunch(CUR_INDEX);
      });
    }catch(_){}

    window.addEventListener('storage', async ev=>{
      if (ev.key !== 'glbingo-spin-evt') return;
      try{
        const d = JSON.parse(ev.newValue||'{}');
        if (Number.isFinite(d.index)) CUR_INDEX = d.index;
        if (d.op === 'gen') onGen(CUR_INDEX);
        else if (d.op === 'launch') onLaunch(CUR_INDEX);
      }catch(_){}
    });

    window.addEventListener('keydown', async e=>{
      if (e.code==='Space'){ e.preventDefault(); if (CUR_INDEX<0) CUR_INDEX=0; onLaunch(CUR_INDEX); }
      else if (e.key==='g' || e.key==='G'){ e.preventDefault(); if (CUR_INDEX<0) CUR_INDEX=0; onGen(CUR_INDEX); }
      else if (/^\d$/.test(e.key)){ CUR_INDEX = Math.max(0, Math.min(19, parseInt(e.key,10))); }
    });

    (function boot(){
      const qi = parseInt(Q.get('i')||'-1',10);
      if (Number.isFinite(qi) && qi>=0 && qi<20) CUR_INDEX = qi;
      setDigits('0000');
    })();
  </script>
</body>
</html>

