<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Spinners Overlay | GL Bingo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Colores base */
      --blueA: 18,36,64;  /* oscuro */
      --blueB: 12,22,42;  /* medio  */
      --belt-opacity: .62;

      /* Dígitos */
      --digitBgTop: #fefefe;
      --digitBgBot: #e7ecfb;
      --digitRimTop:#f9d56c; /* oro */
      --digitRimBot:#e1a93a;

      /* Resaltado final (amarillo) */
      --litColor: #2a1b00;
      --litGlow:  rgba(255,200,40,.55);

      /* Tamaños responsivos */
      --gap: clamp(12px, 2.2vw, 22px);
      --digitW: clamp(86px, 12vw, 146px);
      --digitH: clamp(118px, 15vw, 176px);
      --fzTitle: clamp(28px, 5.8vw, 68px);
      --fzDigit: clamp(58px, 8.6vw, 128px);
      --beltH: clamp(120px, 28vh, 260px);        /* altura de la franja */
      --beltY:  30%;                              /* dónde inicia la franja desde abajo */
    }

    html,body{
      height:100%; margin:0;
      background: transparent;                    /* overlay transparente para vMix */
      display:flex; align-items:center; justify-content:center; color:#e8f4ff;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overflow:hidden;
    }

    /* Franja/degradado que sube desde abajo y muere en el título */
    .belt{
      position: fixed; left:0; right:0; bottom: var(--beltY);
      height: var(--beltH);
      pointer-events:none;
      background:
        linear-gradient(0deg,
          rgba(var(--blueA), var(--belt-opacity)) 0%,
          rgba(var(--blueB), .45) 60%,
          rgba(var(--blueA), 0.00) 100%);
      z-index: 0;
    }

    .wrap{
      position: relative;
      display:flex; flex-direction:column; align-items:center; gap: 16px;
      z-index: 1; /* por encima de la franja */
      padding-inline: clamp(6px, 2vw, 18px);
    }

    /* ===== TÍTULO 3D con alto relieve y colores vibrantes ===== */
    .title3d{
      font-weight: 900; letter-spacing: .22em; text-transform: uppercase;
      font-size: var(--fzTitle); line-height:1; user-select:none;
      /* gradiente multicolor que funciona sobre cualquier fondo */
      background: linear-gradient(180deg,
                  #fff5d6 0%, #ffe08a 28%, #8dd3ff 55%, #59a4ff 70%, #9cc9ff 100%);
      -webkit-background-clip: text; background-clip: text; color: transparent;

      /* Alto relieve (capas) */
      text-shadow:
        0  1px 0  #3558a2,
        0  2px 0  #27457e,
        0  3px 0  #1b2f55,
        0  5px 8px rgba(0,0,0,.35),
        0  12px 24px rgba(0,0,0,.45);

      /* halo exterior sutil */
      filter: drop-shadow(0 10px 18px rgba(140,200,255,.45))
              drop-shadow(0 2px 8px rgba(255,210,80,.35));
    }

    /* Contenedor de dígitos */
    .digits{
      display:flex; gap: var(--gap); align-items:center; justify-content:center;
    }

    /* Carta/dígito */
    .d{
      width: var(--digitW); height: var(--digitH);
      display:flex; align-items:center; justify-content:center;
      position:relative; border-radius:22px; cursor:pointer;
      font-weight:1000; font-size: var(--fzDigit); font-variant-numeric: tabular-nums;

      background: linear-gradient(180deg, var(--digitBgTop) 0%, var(--digitBgBot) 100%);
      color:#0b1630;
      border:1px solid #0003;
      box-shadow:
        inset 0 0 0 2px #ffffffcc,
        inset 0 12px 24px rgba(255,255,255,.35),
        inset 0 -14px 26px rgba(0,0,0,.12),
        0 14px 36px rgba(0,0,0,.45),
        0 0 0 2px #0002;
    }

    /* Marco oro 3D */
    .d::before{
      content:"";
      position:absolute; inset:-6px; border-radius:26px;
      background: linear-gradient(180deg, var(--digitRimTop), var(--digitRimBot));
      box-shadow: 0 2px 0 #7e5819 inset, 0 -2px 0 rgba(255,255,255,.35) inset, 0 16px 34px rgba(0,0,0,.35);
      z-index:-1;
    }

    /* Brillo cristal diagonal */
    .d::after{
      content:""; position:absolute; inset:2px; border-radius:18px;
      background: linear-gradient(145deg,
                  rgba(255,255,255,.65) 0%,
                  rgba(255,255,255,.25) 30%,
                  rgba(255,255,255,0) 40%,
                  rgba(255,255,255,0) 60%,
                  rgba(0,0,0,.06) 100%);
      pointer-events:none; mix-blend-mode: screen;
    }

    /* Hover sutil (no interfiere con vMix) */
    .d:hover{
      box-shadow:
        inset 0 0 0 2px #ffffffcc,
        inset 0 14px 28px rgba(255,255,255,.4),
        inset 0 -16px 30px rgba(0,0,0,.16),
        0 18px 42px rgba(0,0,0,.5),
        0 0 0 2px #0002,
        0 0 24px 4px rgba(80,140,255,.35);
      transform: translateY(-1px);
      transition: box-shadow .18s ease, transform .12s ease;
    }

    /* ===== Resaltado amarillo cuando termina el spinner ===== */
    .d.lit{
      color: var(--litColor);
      text-shadow:
        0 0 2px rgba(255,220,140,.9),
        0 0 10px var(--litGlow),
        0 0 20px var(--litGlow);
      animation: pulseGlow .9s ease-out 1;
    }
    @keyframes pulseGlow{
      0%{ filter: drop-shadow(0 0 0 var(--litGlow)); }
      60%{ filter: drop-shadow(0 0 18px var(--litGlow)); }
      100%{ filter: drop-shadow(0 0 6px  var(--litGlow)); }
    }

    ::-webkit-scrollbar{width:0;height:0}
  </style>
</head>
<body>
  <!-- Franja de degradado que sube y termina en el título -->
  <div class="belt" aria-hidden="true"></div>

  <div class="wrap">
    <div class="title3d">SPINNERS</div>
    <div id="digits" class="digits">
      <div class="d">0</div><div class="d">0</div><div class="d">0</div><div class="d">0</div>
    </div>
  </div>

  <script>
    /* === Lógica original (con mínimo extra para el resaltado amarillo) === */
    const $ = s => document.querySelector(s);
    const qsAll = (s,root=document)=> Array.from(root.querySelectorAll(s));
    const sleep = ms => new Promise(r=>setTimeout(r, ms));
    const BUST = () => (location.search ? '&' : '?') + '_=' + Date.now();
    const Q = new URL(location.href).searchParams;

    const DIGS = 4;
    let LIST = new Array(20).fill('');
    let I = 0;
    let USED = new Set();
    let FECHA = '';

    function kBase(fecha){ return `soloSpin:${fecha}`; }
    function loadUsed(fecha){
      try { const raw = localStorage.getItem(kBase(fecha)+':used'); if(raw) return new Set(JSON.parse(raw)); }
      catch(_){}
      return new Set();
    }
    function saveUsed(fecha,set){ localStorage.setItem(kBase(fecha)+':used', JSON.stringify(Array.from(set))); }
    function saveIdx(fecha){ localStorage.setItem(kBase(fecha)+':idx', String(I)); }
    function readIdx(fecha){ const v = parseInt(localStorage.getItem(kBase(fecha)+':idx')||'0',10); return Number.isFinite(v)?v:0; }

    async function fetchSpinnersJSON(){
      const r = await fetch('/juego/spinners?fmt=json'+BUST());
      if(!r.ok) throw 0;
      const j = await r.json();
      if (!Array.isArray(j.spinners)) throw 0;
      return j.spinners.slice(0,20);
    }
    async function fetchXML(url){
      const r = await fetch(url + (url.includes('?')?'&':'?') + '_=' + Date.now());
      if(!r.ok) throw 0;
      const xml = new DOMParser().parseFromString(await r.text(), 'text/xml');
      const out=[]; xml.querySelectorAll('n').forEach(n=>{
        const v = (n.getAttribute('v') || n.textContent || '').replace(/\D/g,'').slice(0,4);
        out.push(v? v.padStart(4,'0') : '');
      });
      return (out.concat(Array(20).fill(''))).slice(0,20);
    }
    async function fetchSpinnersFallback(){
      try{ return await fetchSpinnersJSON(); }catch(_){}
      try{ return await fetchXML('/static/db/vmix_spinners.xml'); }catch(_){}
      try{ return await fetchXML('/static/db/spinners.xml'); }catch(_){}
      try{
        const r=await fetch('/juego/estado.json'+BUST()); if(r.ok){ const j=await r.json(); if(Array.isArray(j.spinners)) return j.spinners.slice(0,20); }
      }catch(_){}
      return new Array(20).fill('');
    }
    async function resolverFecha(){
      try{ const r=await fetch('/juego/sorteo_fecha'); if(r.ok){ const j=await r.json(); if(j.fecha) return j.fecha; } }catch(_){}
      return new Date().toISOString().slice(0,10);
    }

    function setDigits(text){
      const s = (text||'').toString().padStart(DIGS,'0').slice(-DIGS);
      const boxes = qsAll('.d', $('#digits'));
      boxes.forEach(b=>b.classList.remove('lit'));     // quitar resaltado al preparar
      for (let i=0;i<DIGS;i++) boxes[i].textContent = s[i];
    }
    async function rollDigitTo(el, targetDigit, extraTurns=1){
      let cur = /^\d$/.test(el.textContent) ? parseInt(el.textContent,10) : 0;
      const to = parseInt(targetDigit,10);
      const steps = extraTurns*10 + ((to - cur + 10) % 10);
      for (let s=0;s<steps;s++){
        cur = (cur+1) % 10;
        el.textContent = String(cur);
        const t = 26 + Math.min(180, s*3);
        await sleep(t);
      }
    }
    async function animateTo(targetStr){
      const t = (targetStr||'0000').toString().padStart(DIGS,'0').slice(-DIGS);
      const boxes = qsAll('.d', $('#digits'));
      for(let i=0;i<DIGS;i++){ await rollDigitTo(boxes[i], t[i], 2+i); }
      setDigits(t);                                     // fija el valor final
      boxes.forEach(b=>b.classList.add('lit'));         // ¡resalta en amarillo!
    }

    function targetFor(i){
      const v = (LIST[i]||'').trim();
      return v ? v.padStart(4,'0') : '';
    }
    function isAvailable(i){ const v = targetFor(i); return !!v && !USED.has(i); }
    function nextAvailableFrom(start){
      const n = LIST.length;
      for(let step=0; step<n; step++){ const j=(start+step)%n; if(isAvailable(j)) return j; }
      return -1;
    }

    async function generar(){
      const j = nextAvailableFrom((I+1) % LIST.length);
      if (j !== -1){ I = j; saveIdx(FECHA); setDigits('0000'); }  // vuelve a 0000 y sin resaltado
    }
    async function lanzar(){
      if (I < 0) return;
      const tgt = targetFor(I);
      if (!tgt) return;

      if (USED.has(I)){
        const ok = confirm('Este spinner ya fue lanzado. ¿Deseas volver a lanzarlo?');
        if (!ok) return;
        USED.delete(I); saveUsed(FECHA, USED);
      }

      await animateTo(tgt);
      USED.add(I); saveUsed(FECHA, USED);

      const next = nextAvailableFrom((I+1) % LIST.length);
      I = (next === -1) ? I : next;
      saveIdx(FECHA);
    }

    (async function boot(){
      FECHA = await resolverFecha();
      LIST  = await fetchSpinnersFallback();
      USED  = loadUsed(FECHA);

      const qi = parseInt(Q.get('i')||'');
      if (Number.isFinite(qi) && qi>=0 && qi<LIST.length) I = qi;
      else { I = readIdx(FECHA); if (!isAvailable(I)) I = nextAvailableFrom(I); }
      if (I < 0) I = 0;

      setDigits('0000');

      // Interacciones mínimas (para operador/VMix)
      $('#digits').addEventListener('click', lanzar);
      window.addEventListener('keydown', e=>{
        if (e.code === 'Space'){ e.preventDefault(); lanzar(); }
        else if (e.key === 'g' || e.key === 'G'){ e.preventDefault(); generar(); }
      });
    })();
  </script>
</body>
</html>
