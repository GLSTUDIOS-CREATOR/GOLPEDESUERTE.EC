<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Juego | GL Bingo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --card:#0e182c; --ink:#e8eef8; --muted:#ffffff22;
      --brand:#64b5ff; --gold:#ffd061;
      --red:#ff1f2d; --redSoft:#ff6b73;
      --ok:#23d18b; --warn:#ffb84d; --danger:#ff5364;
      --ring:0 10px 30px rgba(0,0,0,.35);

      --pill-fs: clamp(14px, 1.5vw, 19px);
      --pill-padY: 12px; --pill-padX: 16px;

      --ball: clamp(38px, 4.3vw, 66px);
      --ball-fs: clamp(14px, 1.65vw, 22px);
      --chip: clamp(42px, 5.3vw, 60px);
      --chip-fs: clamp(15px, 1.6vw, 21px);
      --last: clamp(68px, 8.4vw, 102px);
      --last-fs: clamp(30px, 3.8vw, 44px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      background:radial-gradient(90% 90% at 50% 0%, #16294f 0%, #0b1220 60%, #090f1a 100%);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial
    }

    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    nav{background:#0c1426;border-right:1px solid #0f1d36;color:#d6def0;display:flex;flex-direction:column;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;padding:16px 18px;border-bottom:1px solid #0f1d36}
    .brand img{width:34px;height:34px;border-radius:8px}
    .brand .t{font-weight:900;letter-spacing:.2px}
    nav ul{list-style:none;margin:0;padding:8px}
    nav li a{display:flex;align-items:center;gap:10px;color:#d6def0;text-decoration:none;padding:10px 14px;margin:4px 8px;border-radius:10px}
    nav li a:hover{background:#111e39}
    .logout{margin:8px;padding:10px 14px;border-radius:10px;text-decoration:none;text-align:center;color:#f3b4b4;background:#3a0e14;border:1px solid #611f29}

    /* ===== CABECERA ===== */
    header{padding:20px 22px;border-bottom:1px solid #0f1d36;background:linear-gradient(180deg,#122440,#0f1b33)}
    .status{display:flex;gap:16px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .chips{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      background:#0c182e;border:1px solid var(--muted);color:#e9f0fb;border-radius:999px;
      padding:var(--pill-padY) var(--pill-padX);font-weight:800;box-shadow:var(--ring);font-size:var(--pill-fs)
    }
    .pill a{color:#8cc9ff;text-decoration:none}
    .pill.metric{padding: calc(var(--pill-padY) + 4px) calc(var(--pill-padX) + 6px); font-size: clamp(18px, 2.2vw, 26px); letter-spacing:.2px;}

    .last-wrap{display:flex;align-items:center;gap:16px}
    .last-ball{
      width:var(--last); height:var(--last); border-radius:999px;
      background:radial-gradient(120% 120% at 50% 8%, #ffd5d8 0%, var(--redSoft) 45%, var(--red) 100%);
      color:#2a0c11; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:var(--last-fs);
      box-shadow:0 2px 10px rgba(0,0,0,.25),0 0 0 3px #0002 inset,0 0 30px 10px rgba(255,31,45,.45);
      animation:pop .35s ease-out
    }
    @keyframes pop{0%{transform:scale(.85)}100%{transform:scale(1)}}

    .last6{display:flex;gap:12px;align-items:center;background:#0c182e;border:1px solid var(--muted);
      border-radius:999px;padding:12px 16px;font-weight:800;box-shadow:var(--ring);overflow-x:auto}
    .last6::-webkit-scrollbar{height:8px}
    .chip6{min-width:var(--chip); height:var(--chip); border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:var(--chip-fs);
      background:linear-gradient(#fff,#eaf0ff); color:#0e1a2f; border:1px solid #0001; box-shadow:0 2px 8px rgba(0,0,0,.25)}
    .chip6.live{background:radial-gradient(120% 120% at 50% 8%, #ffd5d8 0%, var(--redSoft) 45%, var(--red) 100%); color:#2a0c11; box-shadow:0 2px 10px rgba(0,0,0,.25),0 0 0 2px #0002 inset,0 0 24px 6px rgba(255,31,45,.45); animation:slideIn .35s ease-out}
    @keyframes slideIn{from{transform:translateY(-6px);opacity:.45}to{transform:none;opacity:1}}

    /* ===== CONTROLES ===== */
    .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:14px 22px}
    .btn{border:0;border-radius:12px;font-weight:900;padding:10px 14px;cursor:pointer;box-shadow:var(--ring);transition:transform .06s ease,filter .15s ease}
    .btn:active{transform:translateY(1px)}
    .start{background:var(--ok);color:#05271c}.stop{background:var(--danger);color:#fff}.reset{background:var(--warn);color:#291401}
    .ghost{background:#162542;color:#e8eef8;border:1px solid var(--muted)}
    .spacer{flex:1}

    /* ===== TABLERO ===== */
    .main{padding:0 22px 26px}
    .board{position:relative;background:linear-gradient(180deg,#0f1b33,#0e182c);border:1px solid var(--muted);border-radius:18px;padding:18px;box-shadow:var(--ring)}
    .grid-wrap{overflow-x:auto}
    .grid{display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(var(--ball), 1fr)); min-width: 720px;}
    .ball{width:var(--ball); height:var(--ball); border-radius:999px; display:flex; align-items:center; justify-content:center;
      color:#0f1b33; background:linear-gradient(#ffffff,#e9eef6); font-weight:900; font-size:var(--ball-fs); cursor:pointer; user-select:none;
      border:1px solid #0001; box-shadow:0 2px 8px rgba(0,0,0,.25); transition:transform .08s, box-shadow .2s, background .2s}
    .ball:hover{transform:translateY(-1px)}
    .ball.marked{color:#1b1202; background:radial-gradient(120% 120% at 50% 10%, #fff3cf 0%, var(--gold) 55%, #f1b938 100%);
      box-shadow:0 2px 10px rgba(0,0,0,.25), 0 0 0 2px #0002 inset, 0 0 18px 3px rgba(255,208,98,.45)}
    .ball.last{color:#2a0c11; background:radial-gradient(120% 120% at 50% 8%, #ffd5d8 0%, var(--redSoft) 45%, var(--red) 100%);
      box-shadow:0 2px 10px rgba(0,0,0,.25), 0 0 0 2px #0002 inset, 0 0 22px 6px rgba(255,31,45,.55); animation:pulse 1s ease-out 1}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,31,45,.6)}100%{box-shadow:0 0 0 18px rgba(255,31,45,0)}}

    .lock{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(7,12,22,.72),rgba(7,12,22,.72));border-radius:18px;backdrop-filter:blur(2px);color:#d7def1;font-weight:900;letter-spacing:.3px;font-size:20px}
    .lock .tag{background:#182747;border:1px solid #26406e;padding:10px 14px;border-radius:14px;display:flex;gap:10px;align-items:center}
    .hint{margin-top:8px;opacity:.85;font-size:14px}

    /* ===== FIGURAS DEL D√çA ===== */
    .figs-wrap{padding:0 22px 20px}
    .figs{background:linear-gradient(180deg,#0f1b33,#0e182c);border:1px solid var(--muted);border-radius:18px;padding:16px;box-shadow:var(--ring)}
    .figs h3{margin:0 0 12px;font-size:18px;display:flex;align-items:center;gap:10px}
    .fig-list{display:flex;flex-direction:column;gap:10px}
    .fig-item{display:grid;grid-template-columns:1.2fr .6fr .6fr 1fr;gap:10px;align-items:center;background:#0c182e;border:1px solid var(--muted);border-radius:12px;padding:10px 12px}
    .fig-name{font-weight:900}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-weight:900}
    .badge.ok{background:#112a20;color:#8ef2c6;border:1px solid #1e7f57}
    .badge.no{background:#2a1114;color:#ffb5b9;border:1px solid #7f1e26}
    .btn-xs{border:1px solid #ffffff1f;background:#172a4b;color:#e8eef8;padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-xs.ok{background:#143826;border-color:#1e7f57}
    .btn-xs.no{background:#3a1520;border-color:#7f1e26}
    .btn-xs:active{transform:translateY(1px)}
    /* <-- nuevo: mini toolbar para mostrar la fecha activa */
    .fig-toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin:6px 0 10px}
    .fig-toolbar .pill{padding:6px 10px;font-size:13px}

    /* ===== HISTORIAL ===== */
    .history-wrap{padding:0 22px 28px}
    .history{background:linear-gradient(180deg,#0f1b33,#0e182c);border:1px solid var(--muted);border-radius:18px;padding:16px;box-shadow:var(--ring)}
    .history h3{margin:0 0 10px;font-size:16px;opacity:.9}
    .history-list{display:flex; flex-wrap:wrap; gap:8px; max-height:220px; overflow:auto; padding:6px; background:#0c182e; border:1px solid var(--muted); border-radius:12px}
    .hchip{width:44px; height:44px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:900; background:linear-gradient(#fff,#eaf0ff); color:#0e1a2f; border:1px solid #0001; box-shadow:0 2px 8px rgba(0,0,0,.25); font-size:14px; position:relative}
    .hchip.live{background:radial-gradient(120% 120% at 50% 10%, #fff3cf 0%, var(--gold) 55%, #f1b938 100%); color:#1b1202}
    .order{position:absolute; top:2px; left:4px; font-size:9px; font-weight:800; opacity:.6}

    @media (max-width:980px){ .layout{grid-template-columns:1fr} nav{display:none} .fig-item{grid-template-columns:1fr .6fr .6fr 1fr}}
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <nav>
      <div class="brand">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="">
        <div class="t">GL Bingo</div>
      </div>
      <ul>
        <li><a href="/dashboard">üè† Dashboard</a></li>
        <li><a href="/usuarios">üßë‚Äçüíº Usuarios</a></li>
        <li><a href="/juego/">üé≤ Juego</a></li>
        <li><a href="/contabilidad">üìä Contabilidad</a></li>
        <li><a href="/vendedores">üßæ Vendedores</a></li>
        <li><a href="/asignar-planillas">üìë Asignar Planillas</a></li>
        <li><a href="/impresion">üñ®Ô∏è Impresi√≥n de Boletos</a></li>
        <li><a href="/cobro">üíµ Cobro de Caja</a></li>
        <li><a href="/pago-premios">üèÖ Pago de Premios</a></li>
        <li><a href="/sorteo">üéüÔ∏è Sorteo</a></li>
        <li><a href="/crear-figuras">üü© Crear Figuras</a></li>
        <li><a href="/escoger-figuras">üü¶ Escoger Figuras</a></li>
        <li><a href="/boletin">üìã Bolet√≠n</a></li>
      </ul>
      <a class="logout" href="{{ url_for('logout') }}">‚èª Cerrar sesi√≥n</a>
    </nav>

    <!-- Main -->
    <main>
      <header>
        <div class="status">
          <div class="chips">
            <div class="pill metric">‚è± Segundos: <b id="seg">0</b></div>
            <div class="pill metric">üî¢ Total: <b id="tot">0</b></div>

            <div class="last-wrap">
              <div class="pill">üéØ √öltima Balota</div>
              <div id="ultimoCircle" class="last-ball">‚Äì</div>
            </div>

            <div class="last6" id="last6"><span style="opacity:.85;white-space:nowrap">√öltimas 6:</span></div>

            <div class="pill">XML: <a href="/static/db/datos_bingo.xml" target="_blank">/static/db/datos_bingo.xml</a></div>
          </div>
        </div>
      </header>

      <div class="controls">
        <button id="start" class="btn start">‚ñ∂ INICIAR JUEGO</button>
        <button id="stop"  class="btn stop" disabled>‚õî FINALIZAR JUEGO</button>
        <button id="reset" class="btn reset">üîÅ RESET</button>
        <div class="spacer"></div>
        <button id="rev1"   class="btn ghost">‚Ü© Reversa 1</button>
        <button id="revn"   class="btn ghost">‚Ü© Reversa N‚Ä¶</button>
        <button id="revall" class="btn ghost">‚Ü© Reversa TODO</button>
      </div>

      <div class="main">
        <div class="board">
          <div class="grid-wrap"><div id="grid" class="grid"></div></div>
          <div id="lock" class="lock"><div class="tag">üîí Juego bloqueado ¬∑ Presiona <b>INICIAR JUEGO</b></div></div>
        </div>
        <div class="hint">Para corregir usa <b>Reversa</b>; el clic no desmarca. El atributo <code>ultimo</code> se guarda solo en la balota 1.</div>
      </div>

      <!-- ===== FIGURAS DEL D√çA ===== -->
      <div class="figs-wrap">
        <div class="figs">
          <h3>üß© Figuras del d√≠a (en juego)</h3>

          <!-- NUEVO: barra m√≠nima mostrando la fecha activa -->
          <div class="fig-toolbar">
            <div class="pill">Fecha de sorteo: <b id="figFecha">‚Äî</b></div>
            <button class="btn" id="btnRefrescarFig">‚ü≥ Actualizar</button>
          </div>
          <!-- /NUEVO -->

          <div id="figList" class="fig-list">
            <!-- Se llena por JS -->
          </div>
        </div>
      </div>

      <!-- ===== HISTORIAL ===== -->
      <div class="history-wrap">
        <div class="history">
          <h3>Historial de n√∫meros marcados (orden de salida)</h3>
          <div id="hist" class="history-list"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ================== Estado anterior (juego) ================== */
    let running=false, timer=null, secs=0, stack=[];
    const $ = s => document.querySelector(s);
    const seg=$('#seg'), tot=$('#tot'), last6El=$('#last6'), ultimoCircle=$('#ultimoCircle'),
          grid=$('#grid'), lockEl=$('#lock'), histEl=$('#hist'),
          figListEl = $('#figList');

    function updateSecondsUI(){ seg.textContent = String(secs); }

    function render(){
      const last = stack.at(-1);
      grid.innerHTML='';
      for(let n=1;n<=75;n++){
        const d=document.createElement('div');
        const isMarked = stack.includes(n);
        d.className = isMarked ? (n===last ? 'ball marked last' : 'ball marked') : 'ball';
        d.textContent=n; d.onclick=()=>marcar(n);
        grid.appendChild(d);
        if(n===last) setTimeout(()=>d.style.animation='none', 1000);
      }
      tot.textContent = stack.length;
      ultimoCircle.textContent = last ?? '‚Äì';

      const ult6 = stack.slice(-6).reverse();
      last6El.querySelectorAll('.chip6').forEach(e=>e.remove());
      ult6.forEach((num,i)=>{
        const b=document.createElement('div');
        b.className='chip6 live'; b.textContent=num; b.style.animationDelay=(i*0.03)+'s';
        last6El.appendChild(b);
      });

      histEl.innerHTML='';
      stack.forEach((num,idx)=>{
        const c=document.createElement('div');
        c.className='hchip'+(num===last?' live':'');
        c.innerHTML=`<span class="order">${idx+1}</span>${num}`;
        histEl.appendChild(c);
      });
    }

    function setLockedUI(on){ lockEl.style.display = on ? 'flex' : 'none'; }

    async function cargar(){
      const r=await fetch('/juego/estado.json'); const j=await r.json();
      if(j.ok){ stack=(j.stack||[]).map(Number); render(); }
    }

    async function marcar(n){
      if(!running){ lockEl.animate([{opacity:.9},{opacity:1}],{duration:200}); return; }
      if(stack.includes(n)) return;
      const r=await fetch('/juego/marcar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({numero:n})});
      const j=await r.json();
      if(j.success){
        stack=j.stack.map(Number);
        secs=0; updateSecondsUI();
        render();
      }
    }
    async function reversaK(k){
      const r=await fetch('/juego/reversa',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({k})});
      const j=await r.json(); if(j.success){ stack=j.stack.map(Number); render(); }
    }
    async function reversaAll(){
      const r=await fetch('/juego/reversa',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({all:true})});
      const j=await r.json(); if(j.success){ stack=j.stack.map(Number); render(); }
    }
    async function resetJuego(){
      if(!confirm('¬øSeguro que quieres resetear TODO?')) return;
      const r=await fetch('/juego/reset',{method:'POST'}); const j=await r.json();
      if(j.success){ stack=[]; render(); secs=0; updateSecondsUI(); stop(); }
    }

    function start(){
      if(running) return;
      running=true; setLockedUI(false);
      $('#start').disabled=true; $('#stop').disabled=false;
      timer=setInterval(()=>{ secs++; updateSecondsUI(); },1000);
    }
    function stop(){
      running=false; setLockedUI(true);
      $('#start').disabled=false; $('#stop').disabled=true;
      if(timer){clearInterval(timer); timer=null;}
    }

    ultimoCircle.addEventListener('click', async ()=>{
      const n=stack.at(-1); if(!n) return;
      await fetch('/juego/activar_stinger',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({numero:n})});
      ultimoCircle.style.filter='brightness(1.2)'; setTimeout(()=>ultimoCircle.style.filter='',180);
    });

    $('#start').onclick=start; $('#stop').onclick=stop; $('#reset').onclick=resetJuego;
    $('#rev1').onclick=()=>reversaK(1);
    $('#revn').onclick=()=>{ const k=parseInt(prompt('¬øCu√°ntas balotas quieres reversar?','1'),10); if(Number.isFinite(k)&&k>0) reversaK(k); };
    $('#revall').onclick=reversaAll;

    /* ================== FIGURAS DEL D√çA ================== */
    let figuras = []; // [{nombre, valor, estado}]

    // NUEVO: obtiene la fecha del sorteo desde ?fecha=... o /api/sorteo/fecha, y la muestra
    function getFechaSorteo(){
      const u = new URL(location.href);
      const f = u.searchParams.get('fecha');
      if (f) return f;
      return null; // intentaremos preguntar al backend
    }
    async function resolverFecha(){
      const f = getFechaSorteo();
      if (f) return f;
      try{
        const r = await fetch('/api/sorteo/fecha');     // si existe, la usamos
        if(r.ok){ const j=await r.json(); if(j.fecha) return j.fecha; }
      }catch(e){}
      return new Date().toISOString().slice(0,10);      // fallback: hoy
    }
    async function mostrarFechaToolbar(){
      const f = await resolverFecha();
      const span = document.getElementById('figFecha');
      if(span) span.textContent = f;
      return f;
    }

    function renderFiguras(){
      figListEl.innerHTML='';
      if(!figuras.length){
        const empty = document.createElement('div');
        empty.className='pill'; empty.style.opacity=.85;
        empty.textContent='No hay figuras cargadas.';
        figListEl.appendChild(empty); return;
      }
      figuras.forEach(f=>{
        const row = document.createElement('div');
        row.className='fig-item';

        const name = document.createElement('div');
        name.className='fig-name'; name.textContent = f.nombre;

        const val  = document.createElement('div');
        val.innerHTML = `üí∞ Valor: <b>${f.valor}</b>`;

        const st   = document.createElement('div');
        const badge= document.createElement('span');
        badge.className='badge ' + (f.estado==='se-fue' ? 'no' : 'ok');
        badge.textContent = (f.estado==='se-fue' ? 'Se fue' : 'Se qued√≥');
        st.appendChild(badge);

        const actions = document.createElement('div');
        const bOk = document.createElement('button');
        bOk.className='btn-xs ok'; bOk.textContent='Se qued√≥';
        bOk.onclick = async ()=> {
          const fecha = document.getElementById('figFecha').textContent.trim();
          await setFiguraEstado(f.nombre, 'se-quedo', fecha, badge);
        };

        const bNo = document.createElement('button');
        bNo.className='btn-xs no'; bNo.style.marginLeft='8px'; bNo.textContent='Se fue';
        bNo.onclick = async ()=> {
          const fecha = document.getElementById('figFecha').textContent.trim();
          await setFiguraEstado(f.nombre, 'se-fue', fecha, badge);
        };

        actions.appendChild(bOk); actions.appendChild(bNo);

        row.appendChild(name); row.appendChild(val); row.appendChild(st); row.appendChild(actions);
        figListEl.appendChild(row);
      });
    }

    async function loadFiguras(){
      const fecha = await mostrarFechaToolbar();                       // <-- nuevo
      try{
        // preferimos el nuevo endpoint por fecha
        const r = await fetch(`/api/figuras-para-juego?fecha=${encodeURIComponent(fecha)}`);
        if(!r.ok) throw new Error('no 200');
        const j = await r.json();
        figuras = (j.figuras||[]).map(x=>({ nombre:x.nombre, valor:x.valor, estado:x.estado||'' }));
      }catch(e){
        // fallback a los endpoints antiguos si a√∫n no creaste la API nueva
        try{
          const r2 = await fetch('/juego/figuras');
          const j2 = await r2.json();
          figuras = (j2.figuras||[]).map(x=>({ nombre:x.nombre, valor:x.valor, estado:x.estado||'' }));
        }catch(_){
          figuras = [
            {nombre:'Cart√≥n lleno', valor:300, estado:''},
            {nombre:'Cuatro esquinas', valor:80, estado:''},
            {nombre:'Letra T', valor:120, estado:'se-fue'}
          ];
        }
      }
      renderFiguras();
    }

    async function setFiguraEstado(nombre, estado, fecha, badgeEl){
      // Optimista en UI
      const i = figuras.findIndex(f=>f.nombre===nombre);
      if(i>=0){ figuras[i].estado = estado; }
      if(badgeEl){
        badgeEl.className = 'badge ' + (estado==='se-fue'?'no':'ok');
        badgeEl.textContent = (estado==='se-fue'?'Se fue':'Se qued√≥');
      }
      try{
        // Preferimos guardar por fecha
        const r = await fetch('/api/figura-estado',{
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({fecha, nombre, estado})
        });
        if(!r.ok) throw new Error('no 200');
      }catch(e){
        // fallback al endpoint anterior si a√∫n no existe el nuevo
        try{
          await fetch('/juego/figuras/estado',{
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({nombre, estado})
          });
        }catch(_){}
      }
    }

    /* ================== BOOT ================== */
    setLockedUI(true);
    cargar();
    loadFiguras();

    // bot√≥n refrescar figuras
    const btnRef = document.getElementById('btnRefrescarFig');
    if (btnRef) btnRef.addEventListener('click', loadFiguras);
  </script>
</body>
</html>
